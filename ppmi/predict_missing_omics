


  #  mofa imputation 
# remove for one sample one modality
# impute it 
# and test the corelation 

    
  

library(ggplot2)

# TODO: check again if the DE genes/ proteins are also well predicted!!
# Example on the CLL data
filepath <- system.file("extdata", "CLL_model.hdf5", package = "MOFAdata")
MOFA_CLL <- MOFA2::load_model(filepath)

# predict drug response data using all factors
view="proteomics_t_plasma"
predicted_proteins <- MOFA2::predict(MOFAobject, view=,groups=1,add_intercept = FALSE)
#predicted_proteins <- MOFA2::predict(MOFAobject, view="proteomics_csf",groups=1,add_intercept = FALSE)

predicted_proteins
MOFAobject
original_all<-rownames(na.omit(t(MOFAobject@data[[view]][[1]])))
original_all<-t(na.omit(t(MOFAobject@data[[view]][[1]])))
non_na<-colnames(original_all)
s_id='4029_V08'
predicted=predicted_proteins[[ view]][[1]][, non_na]
original<-MOFAobject@data[[ view]][[1]][,non_na]
original
sm<-samples_metadata(MOFAobject)

sm_coh<-sm[sm$PATNO_EVENT_ID%in% non_na,]$COHORT
sm_coh==1

non_na

original_ps<-original[sm_coh%in% c(2),]
predicted_ps<-predicted[sm_coh%in% c(2),]

# corelations after selection of HC, or PD separately
cors_train<-sapply(seq.int(dim(original_ps)[2]), function(i) cor(original_ps[,i], predicted_ps[,i]))
original_ps
mean(sapply(seq.int(dim(original_ps)[2]), function(i) cor(original_ps[,i], predicted_ps[,i])))
hist(cors_train)

corr.test(original, predicted)
# what about on the DE genes?
# predict all views using all factors (default)
predictedAll <- predict(MOFA_CLL)

# predict Mutation data using all factors, returning Bernoulli probabilities
predictedMutations <- predict(MOFA_CLL, view="Mutations", type="response")

# predict Mutation data using all factors, returning binary classes
predictedMutationsBinary <- predict(MOFA_CLL, view="Mutations", type="inRange")

# Compare the predictions with the true data
pred <- as.numeric(predictedAll$Drugs)
true <- as.numeric(getTrainData(MOFA_CLL)$Drugs)
qplot(pred,true) + geom_hex(bins=100) + coord_equal() + 
   geom_abline(intercept=0, slope=1, col="red")

# Example on the scMT data
filepath <- system.file("extdata", "scMT_model.hdf5", package = "MOFAdata")
MOFA_scMT <- loadModel(filepath)

# Predict all views using all factors (default)
predictedAll <- predict(MOFA_scMT)
 
# Compare the predictions with the true data
view <- "RNA expression"
pred <- as.numeric(predictedAll[[view]])
true <- as.numeric(getTrainData(MOFA_scMT)[[view]])
qplot(pred,true) + geom_hex(bins=100) + coord_equal() + 
   geom_abline(intercept=0, slope=1, col="red") 
